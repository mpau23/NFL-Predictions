NflPredictionsApp.controller("GamesCtrl",["$scope","$rootScope","$http","$q","$stateParams","Game","Team","Prediction",function(e,r,t,o,i,n,a,c){function s(){var o=new Array;return t.get("/api/game/"+i.week).then(function(e){angular.forEach(e.data,function(e,r){date=new Date(e.date),date.setHours(date.getHours()+5);var t=new n(e._id,e.week,date.toString(),new a(e.awayTeam._id,e.awayTeam.shortName,e.awayTeam.fullName),new a(e.homeTeam._id,e.homeTeam.shortName,e.homeTeam.fullName));e.awayScore&&e.homeScore&&(t.awayScore=e.awayScore,t.homeScore=e.homeScore),o.push(t)})}).then(function(){angular.forEach(o,function(o,i){t.get("/api/prediction/"+o.id+"/"+r.currentUser).then(function(r){o.prediction=r.data?new c(r.data.homePrediction,r.data.awayPrediction,r.data.joker):new c(0,0,!1);var t=new Date,i=new Date(o.date);t>i&&(o.started=!0,null!=o.awayScore&&null!=o.homeScore&&(o.points=d(o))),o.started&&o.prediction.joker&&(e.jokerChosen="chosen")})})}),o}function d(e){var r=!1,t=!1,o=!1,i=0;return e.awayScore+e.homeScore==e.prediction.awayPrediction+e.prediction.homePrediction&&(r=!0),e.awayScore<e.homeScore&&e.prediction.awayPrediction<e.prediction.homePrediction&&(t=!0),e.awayScore>e.homeScore&&e.prediction.awayPrediction>e.prediction.homePrediction&&(t=!0),e.awayScore==e.homeScore&&e.prediction.awayPrediction==e.prediction.homePrediction&&(t=!0),e.awayScore==e.prediction.awayPrediction&&e.homeScore==e.prediction.homePrediction&&(o=!0),r&&(i+=5),t&&(i+=10),o&&(i+=15),e.prediction.joker&&(i*=2),i}e.games=s(),e.jokerChosen="",e.date=new Date,e.submit=function(){angular.forEach(e.games,function(e,o){t.post("/api/prediction",{user:r.currentUser,game:e.id,homePrediction:e.prediction.homePrediction,awayPrediction:e.prediction.awayPrediction,joker:e.prediction.joker})})},e.jokerChange=function(r){angular.forEach(e.games,function(e,t){r!=e&&(e.prediction.joker=!1)})}}]),NflPredictionsApp.controller("LeaderboardCtrl",["$scope","$http","$q","Results","User",function(e,r,t,o,i){function n(e,r,t){angular.forEach(c,function(o,i){if(o.predictions[e._id]){var n=!1,a=!1,c=!1,s=0;r+t==o.predictions[e._id].awayPrediction+o.predictions[e._id].homePrediction&&(n=!0),t>r&&o.predictions[e._id].awayPrediction<o.predictions[e._id].homePrediction&&(a=!0),r>t&&o.predictions[e._id].awayPrediction>o.predictions[e._id].homePrediction&&(a=!0),r==t&&o.predictions[e._id].awayPrediction==o.predictions[e._id].homePrediction&&(a=!0),r==o.predictions[e._id].awayPrediction&&t==o.predictions[e._id].homePrediction&&(c=!0),n&&(s+=5),a&&(s+=10),c&&(s+=15),o.predictions[e._id].joker&&(s*=2),o.addPoints(s)}})}function a(){var o=new Date,a=r({method:"GET",url:"/api/user",cache:"true"}),s=r({method:"GET",url:"/api/games/"+o,cache:"true"});t.all([a,s]).then(function(a){var s=a[0].data,d=a[1].data,l=new Array;angular.forEach(s,function(e,t){var o=new i(e.fullName,e.username),n=r.get("/api/predictions/user/"+e.username).then(function(e){angular.forEach(e.data,function(e,r){o.addPrediction(e)})});l.push(n),c.push(o)}),t.all(l).then(function(){var i=new Array;angular.forEach(d,function(e,t){var a=new Date(e.date);a.setHours(a.getHours()+5);var c=0,s=0;if(e.hasOwnProperty("homeScore")&&e.hasOwnProperty("awayScore"))c=e.awayScore,s=e.homeScore,n(e,c,s);else{var d=r.get("/api/results/"+e._id).then(function(t){tempGameResultArray=new Array,console.log(t),angular.forEach(t.data,function(e,r){tempGameResultArray.push(e)}),c=tempGameResultArray[0].away.score.T,s=tempGameResultArray[0].home.score.T;var i=new Date(a);i.setHours(i.getHours()+6),o>i&&r.post("/api/update/game/score",{game:e._id,homeScore:s,awayScore:c})}).then(function(){n(e,c,s)});i.push(d)}}),t.all(i).then(function(){c.sort(function(e,r){return e.points<r.points?1:r.points<e.points?-1:0}),e.users=c})})})}var c=new Array;a()}]),NflPredictionsApp.controller("LoginCtrl",["$scope","$http","Authentication","$location",function(e,r,t,o){e.loginUsername="",e.loginPassword="",t.clearCredentials(),e.login=function(){e.dataLoading=!0,t.login(e.loginUsername,e.loginPassword,function(r){r.error?e.error=r.error:(t.setCredentials(e.loginUsername,e.loginPassword),o.path("/leaderboard"))})},e.registerUsername="",e.registerPassword="",e.registerName="",e.registerEmail="",e.register=function(){t.register(e.registerUsername,e.registerPassword,e.registerName,e.registerEmail,function(r){r.error?e.error=r.error:(t.setCredentials(e.registerUsername,e.registerPassword),o.path("/leaderboard"))})}}]),NflPredictionsApp.controller("RootCtrl",["$scope","$http",function(e,r){e.author="Miren Pau"}]),NflPredictionsApp.controller("TeamsCtrl",["$scope","$http","Team",function(e,r,t){function o(){var e,o=new Array;return r.get("/json/nfl-teams.json").then(function(r){e=r.data.NFLTeams,angular.forEach(e,function(e,r){o.push(new t(e.code,e.shortName,e.fullName))})}),o}e.teams=o()}]),NflPredictionsApp.factory("Authentication",["Base64","$http","$cookies","$rootScope","$timeout",function(e,r,t,o,i){var n={login:function(e,t,o){console.log("Attempting to log in"),r.get("/api/user/"+e+"/"+t).then(function(e){e.data||(e.error="Username or password is incorrect"),o(e)})},register:function(e,t,o,i,n){r.post("/api/user",{fullName:o,email:i,username:e,password:t}).then(function(e){e.data._id||(e.error="There was a problem creating an account"),n(e)})},setCredentials:function(i,n){console.log("Setting credentials");var a=e.encode(i+":"+n);console.log("Basic "+a),o.currentUser=a,r.defaults.headers.common.Authorization="Basic "+a,t.put("currentUser",o.currentUser)},clearCredentials:function(){delete o.currentUser,t.remove("currentUser"),r.defaults.headers.common.Authorization="Basic auth"}};return n}]),NflPredictionsApp.factory("Base64",function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(r){var t,o,i,n,a,c="",s="",d="",l=0;do t=r.charCodeAt(l++),o=r.charCodeAt(l++),s=r.charCodeAt(l++),i=t>>2,n=(3&t)<<4|o>>4,a=(15&o)<<2|s>>6,d=63&s,isNaN(o)?a=d=64:isNaN(s)&&(d=64),c=c+e.charAt(i)+e.charAt(n)+e.charAt(a)+e.charAt(d),t=o=s="",i=n=a=d="";while(l<r.length);return c},decode:function(r){var t,o,i,n,a,c="",s="",d="",l=0,u=/[^A-Za-z0-9\+\/\=]/g;u.exec(r)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");do i=e.indexOf(r.charAt(l++)),n=e.indexOf(r.charAt(l++)),a=e.indexOf(r.charAt(l++)),d=e.indexOf(r.charAt(l++)),t=i<<2|n>>4,o=(15&n)<<4|a>>2,s=(3&a)<<6|d,c+=String.fromCharCode(t),64!=a&&(c+=String.fromCharCode(o)),64!=d&&(c+=String.fromCharCode(s)),t=o=s="",i=n=a=d="";while(l<r.length);return c}}}),NflPredictionsApp.factory("Game",function(){var e=function(e,r,t,o,i){this.id=e,this.week=r,this.date=t,this.awayTeam=o,this.homeTeam=i,this.prediction=null,this.awayScore=null,this.homeScore=null,this.started=!1,this.points=0};return e}),NflPredictionsApp.factory("Prediction",function(){var e=function(e,r,t){this.homePrediction=e,this.awayPrediction=r,this.joker=t};return e}),NflPredictionsApp.factory("Results",function(){var e=function(e,r,t,o){this.id=e,this.week=r,this.users=new Array,this.awayScore=t,this.homeScore=o};return e.prototype.addUser=function(e){this.users.push(e)},e}),NflPredictionsApp.factory("Team",function(){var e=function(e,r,t){this.code=e,this.shortName=r,this.fullName=t};return e}),NflPredictionsApp.factory("User",function(){var e=function(e,r){this.fullName=e,this.username=r,this.predictions=[],this.points=0};return e.prototype.addPrediction=function(e){this.predictions[e.game]=e},e.prototype.addPoints=function(e){this.points+=e},e}),NflPredictionsApp.run(["$rootScope","$location","$cookies","$http",function(e,r,t,o){e.currentUser=t.get("currentUser"),e.currentUser&&(o.defaults.headers.common.Authorization="Basic "+e.currentUser),e.$on("$locationChangeStart",function(o,i,n){e.currentUser;"/login"==r.path()||t.get("currentUser")||r.path("/login")})}]),NflPredictionsApp.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,r,t){t.html5Mode(!0),r.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"}).state("teams",{name:"home.teams",url:"/teams",templateUrl:"views/teams.html",controller:"TeamsCtrl"}).state("games",{name:"home.games",url:"/games/week/:week",templateUrl:"views/games.html",controller:"GamesCtrl"}).state("leaderboard",{name:"home.leaderboard",url:"/leaderboard",templateUrl:"views/leaderboard.html",controller:"LeaderboardCtrl"}).state("login",{name:"home.login",url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"})}]),$(document).on("click",".games-list-title",function(){$(".games-list").toggleClass("show-list"),$("<div class='overlay'></div>").appendTo("body")}),$(document).on("click",".overlay, .link-container a",function(){$(".games-list").toggleClass("show-list"),$(".overlay").remove()}),$(document).on("click",".submit-predictions",function(){$(this).addClass("submitted"),$(this).text("Submitted")});