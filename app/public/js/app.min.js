NflPredictionsApp.controller("GamesCtrl",["$scope","$rootScope","$q","$stateParams","GameService","PredictionService","ScoreService",function(e,t,r,o,n,a,i){function c(){var c=new Array,s=new Array,d=n.getThisWeekGames(o.week),l=a.getThisWeekPredictions(t.currentUser,o.week);r.all([d,l]).then(function(t){c=t[0],s=t[1],angular.forEach(c,function(t,r){s[t.id]&&(t.prediction=s[t.id],t.started&&(null!=t.awayScore&&null!=t.homeScore&&(t.points=i.calculatePoints(t.awayScore,t.homeScore,t.prediction.awayPrediction,t.prediction.homePrediction,t.prediction.joker)),t.prediction.joker&&(e.jokerChosen="chosen")))}),e.games=c})}e.jokerChosen="",c(),e.submit=function(){angular.forEach(e.games,function(e,r){a.setPredictionForGame(t.currentUser,e)})},e.jokerChange=function(t){angular.forEach(e.games,function(e,r){t!=e&&(e.prediction.joker=!1)})}}]),NflPredictionsApp.controller("LeaderboardCtrl",["$scope","$q","Results","UserService","GameService","PredictionService","ScoreService",function(e,t,r,o,n,a,i){function c(){var r=new Date,c=(Date.parse("last wednesday"),o.getAllUsers()),s=n.getGamesBeforeDate(r);t.all([c,s]).then(function(o){var n=o[0],c=o[1],s=new Array;angular.forEach(n,function(e,t){var o=a.getPredictionsBeforeDate(e.username,r);o.then(function(t){e.predictions=t}),s.push(o)}),t.all(s).then(function(t){angular.forEach(c,function(e,t){angular.forEach(n,function(t,r){if("undefined"!=typeof e.awayScore&&"undefined"!=typeof e.homeScore||console.log(e),t.predictions[e.id]&&"undefined"!=typeof e.awayScore&&"undefined"!=typeof e.homeScore){var o=i.calculatePoints(e.awayScore,e.homeScore,t.predictions[e.id].awayPrediction,t.predictions[e.id].homePrediction,t.predictions[e.id].joker);t.addPoints(o),new Date(e.date)>Date.parse("last wednesday")&&t.addThisWeekPoints(o)}})}),n.sort(function(e,t){return e.points<t.points?1:t.points<e.points?-1:0}),e.users=n})})}c()}]),NflPredictionsApp.controller("LoginCtrl",["$scope","$http","AuthenticationService","$location",function(e,t,r,o){e.loginUsername="",e.loginPassword="",r.clearCredentials(),e.login=function(){e.dataLoading=!0,r.login(e.loginUsername,e.loginPassword,function(t){t.error?e.error=t.error:(r.setCredentials(e.loginUsername,e.loginPassword),o.path("/leaderboard"))})},e.registerUsername="",e.registerPassword="",e.registerName="",e.registerEmail="",e.register=function(){r.register(e.registerUsername,e.registerPassword,e.registerName,e.registerEmail,function(t){t.error?e.error=t.error:(r.setCredentials(e.registerUsername,e.registerPassword),o.path("/leaderboard"))})}}]),NflPredictionsApp.controller("RootCtrl",["$scope","$http",function(e,t){e.author="Miren Pau"}]),NflPredictionsApp.controller("TeamsCtrl",["$scope","$http","Team",function(e,t,r){function o(){var e,o=new Array;return t.get("/json/nfl-teams.json").then(function(t){e=t.data.NFLTeams,angular.forEach(e,function(e,t){o.push(new r(e.code,e.shortName,e.fullName))})}),o}e.teams=o()}]),NflPredictionsApp.controller("UpdateGameCtrl",["$scope","GameService",function(e,t){e.getNumberOfWeeks=function(){return new Array(21)},e.updateGame=function(){var r=new Date(e.selectedGameDate);r.setHours(r.getHours()-5),t.updateGameForId(e.selectedGame,e.selectedGameAwayScore,e.selectedGameHomeScore,r)},e.changeWeek=function(r){e.selectedGame=null,e.selectedGameAwayScore="",e.selectedGameHomeScore="",e.selectedGameDate="",t.getThisWeekGames(r).then(function(t){e.thisWeeksGames=t})},e.changeGame=function(t){angular.forEach(e.thisWeeksGames,function(r,o){r.id==t&&(e.selectedGame=r.id,e.selectedGameAwayScore=r.awayScore,e.selectedGameHomeScore=r.homeScore,e.selectedGameDate=r.date)})}}]),NflPredictionsApp.factory("AuthenticationService",["Base64","$http","$cookies","$rootScope",function(e,t,r,o){var n={login:function(r,o,n){console.log("Attempting to log in"),t.get("/api/get/user/by-login/"+e.encode(r+":"+o)).then(function(e){e.data||(e.error=!0),n(e)})},register:function(r,o,n,a,i){t.post("/api/post/user",{fullName:n,email:a,id:e.encode(r+":"+o),username:r}).then(function(e){e.data._id||(e.error=!0),i(e)})},setCredentials:function(n,a){console.log("Setting credentials");var i=e.encode(n+":"+a);console.log("Basic "+i),o.currentUser=i,t.defaults.headers.common.Authorization="Basic "+i,r.put("currentUser",o.currentUser)},clearCredentials:function(){delete o.currentUser,r.remove("currentUser"),t.defaults.headers.common.Authorization="Basic auth"}};return n}]),NflPredictionsApp.factory("Base64",function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var r,o,n,a,i,c="",s="",d="",l=0;do r=t.charCodeAt(l++),o=t.charCodeAt(l++),s=t.charCodeAt(l++),n=r>>2,a=(3&r)<<4|o>>4,i=(15&o)<<2|s>>6,d=63&s,isNaN(o)?i=d=64:isNaN(s)&&(d=64),c=c+e.charAt(n)+e.charAt(a)+e.charAt(i)+e.charAt(d),r=o=s="",n=a=i=d="";while(l<t.length);return c},decode:function(t){var r,o,n,a,i,c="",s="",d="",l=0,u=/[^A-Za-z0-9\+\/\=]/g;u.exec(t)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do n=e.indexOf(t.charAt(l++)),a=e.indexOf(t.charAt(l++)),i=e.indexOf(t.charAt(l++)),d=e.indexOf(t.charAt(l++)),r=n<<2|a>>4,o=(15&a)<<4|i>>2,s=(3&i)<<6|d,c+=String.fromCharCode(r),64!=i&&(c+=String.fromCharCode(o)),64!=d&&(c+=String.fromCharCode(s)),r=o=s="",n=a=i=d="";while(l<t.length);return c}}}),NflPredictionsApp.factory("Game",["Prediction",function(e){var t=function(t,r,o,n,a){this.id=t,this.week=r,this.date=o,this.awayTeam=n,this.homeTeam=a,this.prediction=new e,this.awayScore=null,this.homeScore=null,this.started=!1,this.points=0};return t}]),NflPredictionsApp.factory("GameService",["$http","$q","Game","Team",function(e,t,r,o){var n={getThisWeekGames:function(n){return gamesPromise=e.get("/api/get/game/week/"+n).then(function(e){if(e.data){var n=new Array;return angular.forEach(e.data,function(e,t){date=new Date(e.date);var a=new r(e._id,e.week,date,new o(e.awayTeam._id,e.awayTeam.shortName,e.awayTeam.fullName),new o(e.homeTeam._id,e.homeTeam.shortName,e.homeTeam.fullName));"undefined"!=typeof e.awayScore&&"undefined"!=typeof e.homeScore&&(a.awayScore=e.awayScore,a.homeScore=e.homeScore);var i=new Date,c=new Date(date);i>c&&(a.started=!0),n.push(a)}),n}return t.reject})},getGamesBeforeDate:function(n){return gamesPromise=e.get("/api/get/game/before-date/"+n).then(function(e){if(e.data){var a=new Array;return angular.forEach(e.data,function(e,t){n=new Date(e.date);var i=new r(e._id,e.week,n.toString(),new o(e.awayTeam._id,e.awayTeam.shortName,e.awayTeam.fullName),new o(e.homeTeam._id,e.homeTeam.shortName,e.homeTeam.fullName));"undefined"!=typeof e.awayScore&&"undefined"!=typeof e.homeScore&&(i.awayScore=e.awayScore,i.homeScore=e.homeScore);var c=new Date,s=new Date(n);c>s&&(i.started=!0),a.push(i)}),a}return t.reject})},updateGameForId:function(r,o,n,a){return predictionsSuccessPromise=e.post("/api/post/game",{game:r,homeScore:n,awayScore:o,date:a}).then(function(e){return e.data?e.data:t.reject})}};return n}]),NflPredictionsApp.factory("LocalStorageWrapperService",["localStorageService",function(e){var t={get:function(t){var r=JSON.parse(e.get(t));if(r){var o=new Date(r.expiry),n=new Date;return o>n?(console.log("item retrieved from cache"),r.data):(console.log("cache expired"),null)}return console.log("item not found in cache"),null},set:function(t,r,o){var n=new Date,a={data:r,expiry:n.setMinutes(n.getMinutes()+o)};console.log("saving item to cache"),e.set(t,JSON.stringify(a))}};return t}]),NflPredictionsApp.factory("Prediction",function(){var e=function(e,t,r,o){this.game=e,"undefined"==typeof t?this.homePrediction=0:this.homePrediction=t,"undefined"==typeof r?this.awayPrediction=0:this.awayPrediction=r,"undefined"==typeof o?this.joker=!1:this.joker=o};return e}),NflPredictionsApp.factory("PredictionService",["$http","$q","Prediction","LocalStorageWrapperService",function(e,t,r,o){var n={getThisWeekPredictions:function(o,n){return predictionsPromise=e.get("/api/get/prediction/for-user/"+o+"/week/"+n).then(function(e){if(e.data){var o=[];return angular.forEach(e.data,function(e,t){var n=new r(e.game,e.homePrediction,e.awayPrediction,e.joker);o[n.game]=n}),o}return t.reject})},getPredictionsBeforeDate:function(n,a){var i=o.get("getPredictionsBeforeDate:"+n);if(i){var c=t.defer(),s=[];return angular.forEach(i,function(e,t){var o=new r(e.game,e.homePrediction,e.awayPrediction,e.joker);s[o.game]=o}),c.resolve(s),c.promise}return e.get("/api/get/prediction/for-user/"+n+"/before-date/"+a).then(function(e){if(e.data){o.set("getPredictionsBeforeDate:"+n,e.data,30);var a=[];return angular.forEach(e.data,function(e,t){var o=new r(e.game,e.homePrediction,e.awayPrediction,e.joker);a[o.game]=o}),a}return t.reject})},setPredictionForGame:function(r,o){return predictionsSuccessPromise=e.post("/api/post/prediction",{user:r,game:o.id,homePrediction:o.prediction.homePrediction,awayPrediction:o.prediction.awayPrediction,joker:o.prediction.joker}).then(function(e){return e.data?e.data:t.reject})}};return n}]),NflPredictionsApp.factory("Results",function(){var e=function(e,t,r,o){this.id=e,this.week=t,this.users=new Array,this.awayScore=r,this.homeScore=o};return e.prototype.addUser=function(e){this.users.push(e)},e}),NflPredictionsApp.factory("ScoreService",[function(){var e={calculatePoints:function(e,t,r,o,n){var a=!1,i=!1,c=!1,s=0,d=!1;return r+o===0&&(d=!0),e+t==r+o&&(a=!0),e<t&&r<o&&(i=!0),e>t&&r>o&&(i=!0),e==t&&r==o&&(i=!0),e==r&&t==o&&(c=!0),a&&(s+=5),i&&(s+=10),c&&(s+=15),n&&!d&&(i?s*=2:s-=5),s}};return e}]),NflPredictionsApp.factory("Team",function(){var e=function(e,t,r){this.code=e,this.shortName=t,this.fullName=r};return e}),NflPredictionsApp.factory("User",function(){var e=function(e,t){this.fullName=e,this.username=t,this.predictions=[],this.points=0,this.thisWeekPoints=0};return e.prototype.addPrediction=function(e){this.predictions[e.game]=e},e.prototype.addPoints=function(e){this.points+=e},e.prototype.addThisWeekPoints=function(e){this.thisWeekPoints+=e},e}),NflPredictionsApp.factory("UserService",["$http","$q","User","LocalStorageWrapperService",function(e,t,r,o){var n={getAllUsers:function(){var n=o.get("getAllUsers");if(n){var a=t.defer(),i=new Array;return angular.forEach(n,function(e,t){i.push(new r(e.fullName,e.username))}),a.resolve(i),a.promise}return e.get("/api/get/user/all").then(function(e){if(e.data){o.set("getAllUsers",e.data,720);var n=new Array;return angular.forEach(e.data,function(e,t){n.push(new r(e.fullName,e.username))}),n}return t.reject})}};return n}]),NflPredictionsApp.run(["$rootScope","$location","$cookies","$http",function(e,t,r,o){e.currentUser=r.get("currentUser"),e.currentUser&&(o.defaults.headers.common.Authorization="Basic "+e.currentUser),e.$on("$locationChangeStart",function(o,n,a){e.currentUser;"/login"==t.path()||r.get("currentUser")||t.path("/login")})}]),NflPredictionsApp.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,r){r.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"}).state("teams",{name:"home.teams",url:"/teams",templateUrl:"views/teams.html",controller:"TeamsCtrl"}).state("games",{name:"home.games",url:"/games/week/:week",templateUrl:"views/games.html",controller:"GamesCtrl"}).state("leaderboard",{name:"home.leaderboard",url:"/leaderboard",templateUrl:"views/leaderboard.html",controller:"LeaderboardCtrl"}).state("login",{name:"home.login",url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("updateGame",{name:"home.updateGame",url:"/update-game",templateUrl:"views/update-game.html",controller:"UpdateGameCtrl"})}]),$(document).on("click",".submit-predictions",function(){$(this).addClass("submitted"),$(this).text("Submitted")}),$(".menu-link").click(function(){$(".overlay").remove(),$("body").toggleClass("menu-open"),$("<div class='overlay'></div>").appendTo("body")}),$(document).on("click",".overlay",function(){$("body").toggleClass("menu-open"),$(".overlay").remove()}),$(".nav-sub-link").click(function(){$(this).next("ul").toggleClass("open")}),$("nav a").click(function(){$(this).hasClass("nav-sub-link")||($("body").toggleClass("menu-open"),$(".overlay").remove())});