NflPredictionsApp.controller("GamesCtrl",["$scope","$rootScope","$http","$q","$stateParams","Game","Team","Prediction",function(e,t,r,a,o,n,i,s){function c(){var a=new Array;return r.get("/api/game/"+o.week).then(function(e){angular.forEach(e.data,function(e,t){date=new Date(e.date),date.setHours(date.getHours()+5),a.push(new n(e._id,e.week,date.toString(),new i(e.awayTeam._id,e.awayTeam.shortName,e.awayTeam.fullName),new i(e.homeTeam._id,e.homeTeam.shortName,e.homeTeam.fullName)))})}).then(function(){angular.forEach(a,function(a,o){r.get("/api/prediction/"+a.id+"/"+t.currentUser).then(function(t){a.prediction=t.data?new s(t.data.homePrediction,t.data.awayPrediction,t.data.joker):new s(0,0,!1);var r=new Date,o=new Date(a.date);r>o&&(a.started=!0),a.started&&a.prediction.joker&&(e.jokerChosen="chosen")})})}),a}e.games=c(),e.jokerChosen="",e.date=new Date,e.pushGames=function(){var e,t,a=new Array;r.get("/json/nfl-fixtures.json").then(function(o){e=o.data.Schedule,t=o.data.centerIds;var i,s,c=0;angular.forEach(e,function(e,r){angular.forEach(t,function(t,r){t.week===e.gameWeek&&(i=t),angular.forEach(i.games,function(t,r){t.home===e.homeTeam&&(s=t.id)})}),i.games[c]||(c=0),a.push(new n(s,e.gameWeek,e.gameDate+" "+e.gameTimeET,e.awayTeam,e.homeTeam)),c++}),angular.forEach(a,function(e,t){r.post("/api/game",{id:e.id,week:e.week,homeTeam:e.homeTeamId,awayTeam:e.awayTeamId,date:e.date})})})},e.submit=function(){angular.forEach(e.games,function(e,a){r.post("/api/prediction",{user:t.currentUser,game:e.id,homePrediction:e.prediction.homePrediction,awayPrediction:e.prediction.awayPrediction,joker:e.prediction.joker})})},e.jokerChange=function(t){angular.forEach(e.games,function(e,r){t!=e&&(e.prediction.joker=!1)})}}]),NflPredictionsApp.controller("LeaderboardCtrl",["$scope","$http","$q","Results","User",function(e,t,r,a,o){function n(e,t,r){angular.forEach(s,function(a,o){if(a.predictions[e._id]){var n=!1,i=!1,s=!1,c=0;t+r==a.predictions[e._id].awayPrediction+a.predictions[e._id].homePrediction&&(n=!0),r>t&&a.predictions[e._id].awayPrediction<a.predictions[e._id].homePrediction&&(i=!0),t>r&&a.predictions[e._id].awayPrediction>a.predictions[e._id].homePrediction&&(i=!0),t==r&&a.predictions[e._id].awayPrediction==a.predictions[e._id].homePrediction&&(i=!0),t==a.predictions[e._id].awayPrediction&&r==a.predictions[e._id].homePrediction&&(s=!0),n&&(c+=5),i&&(c+=10),s&&(c+=15),a.predictions[e._id].joker&&(c*=2),a.addPoints(c)}})}function i(){var a=new Date,i=t({method:"GET",url:"/api/user",cache:"true"}),c=t({method:"GET",url:"/api/games/"+a,cache:"true"});r.all([i,c]).then(function(i){var c=i[0].data,d=i[1].data,l=new Array;angular.forEach(c,function(e,r){var a=new o(e.fullName,e.username),n=t.get("/api/predictions/user/"+e.username).then(function(e){angular.forEach(e.data,function(e,t){a.addPrediction(e)})});l.push(n),s.push(a)}),r.all(l).then(function(){var o=new Array;angular.forEach(d,function(e,r){var i=new Date(e.date);i.setHours(i.getHours()+5);var s=0,c=0;if(e.hasOwnProperty("homeScore")&&e.hasOwnProperty("awayScore"))s=e.awayScore,c=e.homeScore,n(e,s,c);else{var d=t.get("/api/results/"+e._id).then(function(r){tempGameResultArray=new Array,angular.forEach(r.data,function(e,t){tempGameResultArray.push(e)}),s=tempGameResultArray[0].away.score.T,c=tempGameResultArray[0].home.score.T;var o=new Date(i);o.setHours(o.getHours()+6),a>o&&t.post("/api/update/game/score",{game:e._id,homeScore:c,awayScore:s})}).then(function(){n(e,s,c)});o.push(d)}}),r.all(o).then(function(){s.sort(function(e,t){return e.points<t.points?1:t.points<e.points?-1:0}),e.users=s})})})}var s=new Array;i()}]),NflPredictionsApp.controller("LoginCtrl",["$scope","$http","Authentication","$location",function(e,t,r,a){e.loginUsername="",e.loginPassword="",r.clearCredentials(),e.login=function(){e.dataLoading=!0,r.login(e.loginUsername,e.loginPassword,function(t){t.error?e.error=t.error:(r.setCredentials(e.loginUsername,e.loginPassword),a.path("/leaderboard"))})},e.registerUsername="",e.registerPassword="",e.registerName="",e.registerEmail="",e.register=function(){r.register(e.registerUsername,e.registerPassword,e.registerName,e.registerEmail,function(t){t.error?e.error=t.error:(r.setCredentials(e.registerUsername,e.registerPassword),a.path("/leaderboard"))})}}]),NflPredictionsApp.controller("RootCtrl",["$scope","$http",function(e,t){e.author="Miren Pau"}]),NflPredictionsApp.controller("TeamsCtrl",["$scope","$http","Team",function(e,t,r){function a(){var e,a=new Array;return t.get("/json/nfl-teams.json").then(function(t){e=t.data.NFLTeams,angular.forEach(e,function(e,t){a.push(new r(e.code,e.shortName,e.fullName))})}),a}e.teams=a()}]),NflPredictionsApp.factory("Authentication",["Base64","$http","$cookies","$rootScope","$timeout",function(e,t,r,a,o){var n={login:function(e,r,a){console.log("Attempting to log in"),t.get("/api/user/"+e+"/"+r).then(function(e){e.data||(e.error="Username or password is incorrect"),a(e)})},register:function(e,r,a,o,n){t.post("/api/user",{fullName:a,email:o,username:e,password:r}).then(function(e){e.data._id||(e.error="There was a problem creating an account"),n(e)})},setCredentials:function(o,n){console.log("Setting credentials");var i=e.encode(o+":"+n);console.log("Basic "+i),a.currentUser=i,t.defaults.headers.common.Authorization="Basic "+i,r.put("currentUser",a.currentUser)},clearCredentials:function(){delete a.currentUser,r.remove("currentUser"),t.defaults.headers.common.Authorization="Basic auth"}};return n}]),NflPredictionsApp.factory("Base64",function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var r,a,o,n,i,s="",c="",d="",l=0;do r=t.charCodeAt(l++),a=t.charCodeAt(l++),c=t.charCodeAt(l++),o=r>>2,n=(3&r)<<4|a>>4,i=(15&a)<<2|c>>6,d=63&c,isNaN(a)?i=d=64:isNaN(c)&&(d=64),s=s+e.charAt(o)+e.charAt(n)+e.charAt(i)+e.charAt(d),r=a=c="",o=n=i=d="";while(l<t.length);return s},decode:function(t){var r,a,o,n,i,s="",c="",d="",l=0,u=/[^A-Za-z0-9\+\/\=]/g;u.exec(t)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do o=e.indexOf(t.charAt(l++)),n=e.indexOf(t.charAt(l++)),i=e.indexOf(t.charAt(l++)),d=e.indexOf(t.charAt(l++)),r=o<<2|n>>4,a=(15&n)<<4|i>>2,c=(3&i)<<6|d,s+=String.fromCharCode(r),64!=i&&(s+=String.fromCharCode(a)),64!=d&&(s+=String.fromCharCode(c)),r=a=c="",o=n=i=d="";while(l<t.length);return s}}}),NflPredictionsApp.factory("Game",function(){var e=function(e,t,r,a,o,n,i,s){this.id=e,this.week=t,this.date=r,this.awayTeam=a,this.homeTeam=o,this.prediction=n,this.awayScore=i,this.homeScore=s,this.started=!1};return e}),NflPredictionsApp.factory("Prediction",function(){var e=function(e,t,r){this.homePrediction=e,this.awayPrediction=t,this.joker=r};return e}),NflPredictionsApp.factory("Results",function(){var e=function(e,t,r,a){this.id=e,this.week=t,this.users=new Array,this.awayScore=r,this.homeScore=a};return e.prototype.addUser=function(e){this.users.push(e)},e}),NflPredictionsApp.factory("Team",function(){var e=function(e,t,r){this.code=e,this.shortName=t,this.fullName=r};return e}),NflPredictionsApp.factory("User",function(){var e=function(e,t){this.fullName=e,this.username=t,this.predictions=[],this.points=0};return e.prototype.addPrediction=function(e){this.predictions[e.game]=e},e.prototype.addPoints=function(e){this.points+=e},e}),NflPredictionsApp.run(["$rootScope","$location","$cookies","$http",function(e,t,r,a){e.currentUser=r.get("currentUser"),e.currentUser&&(a.defaults.headers.common.Authorization="Basic "+e.currentUser),e.$on("$locationChangeStart",function(a,o,n){e.currentUser;"/login"==t.path()||r.get("currentUser")||t.path("/login")})}]),NflPredictionsApp.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,r){r.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"}).state("teams",{name:"home.teams",url:"/teams",templateUrl:"views/teams.html",controller:"TeamsCtrl"}).state("games",{name:"home.games",url:"/games/week/:week",templateUrl:"views/games.html",controller:"GamesCtrl"}).state("leaderboard",{name:"home.leaderboard",url:"/leaderboard",templateUrl:"views/leaderboard.html",controller:"LeaderboardCtrl"}).state("login",{name:"home.login",url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"})}]),$(document).on("click",".games-list-title",function(){$(".games-list").toggleClass("show-list"),$("<div class='overlay'></div>").appendTo("body")}),$(document).on("click",".overlay, .link-container a",function(){$(".games-list").toggleClass("show-list"),$(".overlay").remove()}),$(document).on("click",".submit-predictions",function(){$(this).addClass("submitted"),$(this).text("Submitted")});